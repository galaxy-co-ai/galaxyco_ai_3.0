#!/usr/bin/env sh

set -e

# Auto-update AI_CONTEXT.md after each commit, and auto-commit the result.
#
# Why post-commit?
# - Keeps a single committed snapshot for any new AI agent
# - Avoids session-log file sprawl
# - Avoids the working tree being left dirty
#
# Guard: skip when the last commit only touched AI_CONTEXT.md (prevents loops).
changed_files="$(git diff-tree --no-commit-id --name-only -r HEAD | tr -d '\r')"
last_subject="$(git log -1 --pretty=%s | tr -d '\r')"

if [ "$changed_files" = "docs/status/AI_CONTEXT.md" ] || [ "$last_subject" = "docs(status): update AI context" ]; then
  exit 0
fi

npm run update-context

# Commit only if the generator actually changed the file.
if ! git diff --quiet -- docs/status/AI_CONTEXT.md; then
  git add docs/status/AI_CONTEXT.md
  git commit -m "docs(status): update AI context" --no-verify
fi
